<style>
canvas{display:block;width:100vw;height:100vh;background:#000;}
#controls{position:fixed;top:10px;left:10px;color:#fff;z-index:100;}
button,select{margin:5px;padding:5px;}
</style>

<div id="controls">
  <select id="abilitySelect">
    <option value="teleportation">Teleportation</option>
    <option value="telekinesis">Telekinesis</option>
    <option value="shapeshifting">Shapeshifting</option>
    <option value="exnihilo">Ex Nihilo</option>
    <option value="invincibility">Invincibility</option>
  </select>
  <button id="triggerBackflow">Trigger Backflow</button>
</div>

<canvas id="toybiCanvas"></canvas>

<script>
class ToybiNode{
  constructor(id,branch,inhibitors,microPrompts,tryNode=false){
    this.id=id;
    this.branch=branch;
    this.inhibitors=inhibitors;
    this.microPrompts=microPrompts;
    this.tryNode=tryNode;
    this.symbols="⧫⧫⧫⧫ ░▒▓█░▒▓█ ϞϞ ϟϟ ◊◊ △△ ⧫⧫ ◈◈ ◉◉";
    this.children=[];
    this.angle=Math.random()*Math.PI*2;
    this.radius=15 + this.symbols.length/4;
    this.x=0; this.y=0;
  }

  propagate(token=10){
    if(token<=0) return;
    for(let i=0;i<2;i++){
      let branchType=i===0?'good':'evil';
      let child=new ToybiNode(this.id+'.'+token,branchType,[...this.inhibitors],[...this.microPrompts],token===8);
      this.children.push(child);
      child.propagate(token-1);
    }
  }

  backflow(){
    this.microPrompts=this.microPrompts.map(m=>m+"-rev");
    this.inhibitors=this.inhibitors.map(i=>i+"+");
    this.children.forEach(c=>c.backflow());
  }

  render(ctx, x, y, ability){
    this.x=x; this.y=y;
    let hue;
    switch(ability){
      case 'teleportation': hue=180; break;
      case 'telekinesis': hue=280; break;
      case 'shapeshifting': hue=50; break;
      case 'exnihilo': hue=0; break;
      case 'invincibility': hue=120; break;
      default: hue=200;
    }
    ctx.beginPath();
    ctx.arc(x,y,this.radius,0,2*Math.PI);
    let alpha=this.tryNode?1:0.7;
    ctx.fillStyle=`hsla(${hue},100%,50%,${alpha})`;
    ctx.fill();
    if(this.tryNode){
      ctx.shadowColor='gold';
      ctx.shadowBlur=20;
    }
    // animate children with microPrompts
    let spread=50;
    this.children.forEach((c,i)=>{
      let dx=Math.cos(c.angle)*spread*(i+1);
      let dy=Math.sin(c.angle)*spread*(i+1);
      c.angle+=0.01*(i+1)*(Math.random()>.5?1:-1); // micro-movement
      c.render(ctx,x+dx,y+dy,ability);
    });
  }

  playSound(){
    if(!window.AudioContext) return;
    if(!ToybiNode.ctx) ToybiNode.ctx=new AudioContext();
    let osc=ToybiNode.ctx.createOscillator();
    osc.type='sine';
    osc.frequency.setValueAtTime(100 + this.symbols.length*2, ToybiNode.ctx.currentTime);
    let gain=ToybiNode.ctx.createGain();
    gain.gain.setValueAtTime(0.01, ToybiNode.ctx.currentTime);
    osc.connect(gain).connect(ToybiNode.ctx.destination);
    osc.start();
    osc.stop(ToybiNode.ctx.currentTime+0.05);
    this.children.forEach(c=>c.playSound());
  }
}

let canvas=document.getElementById('toybiCanvas');
let ctx=canvas.getContext('2d');
canvas.width=window.innerWidth;
canvas.height=window.innerHeight;
let rootNode;

function initToyobi(ability){
  let microPrompts;
  switch(ability){
    case 'teleportation': microPrompts=['Dir','Vel','Phase']; break;
    case 'telekinesis': microPrompts=['ForceDir','Intensity','Phase']; break;
    case 'shapeshifting': microPrompts=['FormDir','TransformInt','Phase']; break;
    case 'exnihilo': microPrompts=['CreateInt','ExpandDir','Phase']; break;
    case 'invincibility': microPrompts=['DefDir','Strength','Phase']; break;
    default: microPrompts=['Dir','Int','Phase'];
  }
  rootNode=new ToybiNode(ability,'good',['Inhib1','Inhib2','Inhib3'],microPrompts,true);
  rootNode.propagate(10);
  rootNode.playSound();
}

function animate(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  rootNode.render(ctx,canvas.width/2,canvas.height/2,document.getElementById('abilitySelect').value);
  requestAnimationFrame(animate);
}

document.getElementById('abilitySelect').onchange=function(){
  initToyobi(this.value);
};
document.getElementById('triggerBackflow').onclick=function(){
  rootNode.backflow();
  rootNode.playSound();
};

initToyobi('teleportation');
animate();
</script>
